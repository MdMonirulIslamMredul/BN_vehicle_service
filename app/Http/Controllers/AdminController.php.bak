<?php

namespace App\Http\Controllers;

use App\Models\User;
use App\Models\Vehicle;
use App\Models\Appointment;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;

class AdminController extends Controller
{
    //
    public function index(){
        return view('/admin/dashboard');
    }

    public function users(Request $request)
    {
        $search = $request->get('search');
        $role = $request->get('role');
        $status = $request->get('status');

        $users = User::where('role', '!=', 'admin')
            ->when($search, function ($query, $search) {
                $query->where(function ($q) use ($search) {
                    $q->where('name', 'like', "%{$search}%")
                      ->orWhere('email', 'like', "%{$search}%")
                      ->orWhere('phone', 'like', "%{$search}%");
                });
            })
            ->when($role && $role !== 'all', function ($query, $role) {
                $query->where('role', $role);
            })
            ->when($status && $status !== 'all', function ($query) use ($status) {
                $query->where('is_active', $status === 'active' ? 1 : 0);
            })
            ->orderBy('created_at', 'desc')
            ->paginate(10)
            ->appends($request->only(['search', 'role', 'status']));

        return view('admin.users.index', compact('users', 'search', 'role', 'status'));
    }

    public function toggleUserActive(User $user)
    {
        if ($user->role === 'admin') {
            return back()->with('error', 'Cannot change status for admin users.');
        }

        $user->is_active = !$user->is_active;
        $user->save();

        return back()->with('success', 'User status updated successfully.');
    }

    public function resetUserPassword(User $user)
    {
        if ($user->role === 'admin') {
            return back()->with('error', 'Cannot reset password for admin users.');
        }

        $user->password = Hash::make('12345678');
        $user->save();

        return back()->with('success', "Password reset to '12345678' for user.");
    }

    // Show all vehicles
    public function vehicles(Request $request)
    {
        $search = $request->get('search');
        $role = $request->get('role');

        $vehicles = Vehicle::with('user')
            ->when($search, function ($query, $search) {
                $query->where(function ($q) use ($search) {
                    $q->where('chassis_number', 'like', "%{$search}%")
                      ->orWhere('registration_number', 'like', "%{$search}%");
                });
            })
            ->when($role && $role !== 'all', function ($query, $role) {
                $query->whereHas('user', function ($q) use ($role) {
                    $q->where('role', $role);
                });
            })
            ->latest()
            ->paginate(10)
            ->appends($request->only(['search', 'role']));

        return view('admin.vehicles.index', compact('vehicles', 'search', 'role'));
    }




    // Show all appointments
   public function appointments( Request $request)
    {
        // Fetch all appointments as Eloquent models (casts will work)
        // $appointments = Appointment::orderBy('date', 'desc')->get();
        // $appointments = Appointment::orderByRaw("CASE WHEN status = 'not_connected' THEN 0 ELSE 1 END")
        // ->orderBy('date', 'desc')
        // ->get();

        $filter = $request->get('status');

         $appointments = Appointment::when($filter && $filter !== 'all', function ($query) use ($filter) {
            $query->where('status', $filter);
        })
        ->orderByRaw("CASE WHEN status = 'not_connected' THEN 0 ELSE 1 END")
        ->orderBy('date')
        ->paginate(10); // Paginate with 10 items per page


        return view('admin.appointments.index', compact('appointments', 'filter'));
    }


    public function updateAppointmentStatus($id)
    {
        $appointment = Appointment::findOrFail($id);

        $appointment->status = $appointment->status === 'connected' ? 'not_connected' : 'connected';
        $appointment->save();

        return redirect()->back()->with('success', 'Appointment status updated successfully.');
    }



}
